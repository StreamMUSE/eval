# NLL Compute Runners (NLL 计算执行器)

This directory contains standalone Command Line Interface (CLI) scripts that utilize the core modules from `nll_compute` (`core.py`, `batch.py`, `aggregate.py`, `plot.py`). They are designed to be executed directly from the terminal to perform specific NLL-related tasks.
本目录包含独立的命令行界面 (CLI) 脚本，这些脚本利用了 `nll_compute` 的核心模块。它们被设计为直接从终端执行，以完成特定的 NLL 相关任务。

## Scripts (包含脚本)

### 1. `run_cal_nll.py`
Calculates the Negative Log-Likelihood (NLL) for all generated MIDI files within a specified directory and saves the per-file results to a JSON file.
*(计算指定目录下所有生成的 MIDI 文件的被模型给出此生成的负对数似然 (NLL) 值，并将每个文件的结果保存到 JSON 文件中。)*

**Options (常用选项):**
- `--ckpt_path`: Path to the RoFormer model checkpoint.
- `--midi_dir`: Directory containing the target `.mid` or `.pt` files.
- `--save_json_path`: Output path for the detailed JSON results.
- `--window`, `--offset`: Sliding window sliding parameters for the Transformer model.

### 2. `run_aggregate.py`
Aggregates the individual file NLL results generated by `run_cal_nll.py` into a summary statistical report (including median, max, min, and weighted averages based on sequence length).
*(将 `run_cal_nll.py` 生成的单个文件 NLL 结果聚合为一个汇总的统计报告（包括中位数、最大值、最小值以及基于序列长度的加权平均值）。)*

**Options (常用选项):**
- `--input`: Path to the input JSON file containing per-file NLLs.
- `--output`: Path to save the aggregated summary JSON.
- `--pretty`: Output JSON with human-readable indentation.

### 3. `run_heatmap.py`
Parses a directory containing multiple NLL result JSONs mapping different experiment configurations (like variable prompts and generation lengths) and visualizes them as a 2D Heatmap using Seaborn.
*(解析包含多个 NLL 结果 JSON 的目录（这些 JSON 映射了不同的实验配置，如可变提示长度和生成长度），并使用 Seaborn 将结果可视化为 2D 热力图。)*

**Options (常用选项):**
- `--input-dir`: Target directory containing `.nll.json` files.
- `--out`: Path to save the resulting heatmap image (`.png` / `.pdf`).
- `--csv-out`: Path to save the underlying pivot table data as a CSV.
- `--value-mode`: Choose between `avg_mean` (unweighted) or `weighted_avg`.

### 4. `run_from_manifest.py`
An orchestrator script that takes a JSON manifest file listing multiple input MIDI directories, systematically runs the `cal_nll` process on all of them, merges the raw results, and performs a final aggregation.
*(一个编排脚本。接收一个包含多个输入 MIDI 目录列表的 JSON 清单文件，系统地对它们全部执行 `cal_nll` 计算，合并原始结果，并执行最终的全局聚合。)*

**Options (常用选项):**
- `--manifest`: Path to the `midi_dirs.json` manifest.
- `--ckpt`: Path to the loaded model checkpoint.
- `--out`: Root output directory for all generated metrics and aggregates.
- `--process-root-as-dir`: Treat the manifest root target directly as a container of `.mid` files rather than looking into its subdirectories.

## Execution Pattern (运行方式)

Always run these scripts as python modules from the root of the `StreamMUSE` repository to ensure correct relative imports:
*(务必从 `StreamMUSE` 仓库根目录将这些脚本作为 Python 模块运行，以确保相对导入路径正确：)*

```bash
# Correct (正确)
python -m move_to_eval.nll_compute.runners.run_cal_nll --help

# Incorrect (错误)
python move_to_eval/nll_compute/runners/run_cal_nll.py --help
```
